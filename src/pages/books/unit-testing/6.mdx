---
id: 단위 테스트
title: '5장, 목과 테스트 취약성'
description: '단위 테스트 책을 읽고 내용을 정리합니다.'
keywords: 'unit testing, book, study'
createdAt: 2022.04.05
---

## 6.1 단위 테스트의 세 가지 스타일

단위 테스트는 세 가지 스타일이 있다.

- **출력 기반 테스트(output-based testing)**
  - 세 가지 중 가장 품질이 좋다.
  - 아무데서나 사용할 수 없으며, 순수 함수 방식으로 작성된 코드에만 적용된다.
- **상태 기반 테스트(state-based testing)**
  - 두번 째로 좋은 선택.
- **통신 기반 테스트(communication-based testing)**
  - 간헐적으로 사용해야 한다.

### 6.1.1 출력 기반 테스트 정의

**출력 기반 스타일은 SUT에 입력을 넣고 생성되는 출력을 점검하는 방식**이다.<br/>
이러한 스타일은 전역 상태나 내부 상태를 변경하지 않는 코드에만 적용되므로 반환 값만 검증하면 된다.<br/>

<img src='/assets/images/unit-testing-16.jpg' />
<br />

출력 기반 단위 테스트 스타일은 **함수형(functional)**이라고도 한다.<br/>
부작용 없는 코드 선호를 강조하는 프로그래밍 방식인 함수형 프로그래밍에 뿌리를 두고 있다.

### 6.1.2 상태 기반 스타일 정의

**상태 기반 스타일은 작업이 완료된 후 시스템 상태를 확인하는 것**이다.<br/>
상태라는 용어는 SUT나 협력자 중 하나, 또는 데이터베이스나 파일 시스템 등과 같은 프레시스 외부 의존성의 상태 등을 의미할 수 있다.

<img src='/assets/images/unit-testing-17.jpg' />
<br />

### 6.1.3 통신 기반 스타일 정의

**통신 기반 스타일은 목을 사용해 SUT와 협렵자 간의 통신을 검증**한다.

<img src='/assets/images/unit-testing-18.jpg' />
<br />

## 6.2 단위 테스트 스타일 비교

좋은 단위 테스트의 4대 요소를 통해 각 스타일을 비교해 보자.

- 회귀 방지
- 리팩터링 내성
- 빠른 피드백
- 유지 보수성

### 6.2.1 회귀 방지와 피드백 속도 지표로 스타일 비교하기

**테스트 스타일과 테스트 피드백 속도 사이에는 상관관계가 거의 없다.**<br/>
테스트가 프로세스 외부 의존성과 떨어져 단위 테스트 영역에 있는 한,
모든 스타일은 테스트 실행 속도가 거의 동일하다.<br/>
목은 런타임에 지연 시간이 생기는 편이므로 통신. 기반 테스트가 약간 나쁠 수 있다.<br/>
그러나 이러한 테스트가 수만개 수준이 아니라면 별 차이는 없다.

### 6.2.2 리팩터링 내성 지표로 스타일 비교하기

**출력 기반 테스트는 테스트가 테스트 대상 메서드에만 결합되므로 거짓 양성 방지가 가장 우수하다.**<br/>
테스트가 구현 세부 사항에 결합하는 경우는 테스트 대상 메서드가 구현 세부 사항일 때뿐이다.<br/>

**상태 기반 테스트는 일반적으로 거짓 양성이 되기 쉽다.**<br/>
이러한 테스트는 테스트 대상 메서드 외에도 클래스 상태와 함께 작동한다.<br/>

**통신 기반 테스트가 허위 경보에 가장 취약하다.**<br/>
테스트 대역으로 상호 작용을 확인하는 테스트는 대부분 깨지기 쉽다.<br/>

피상적인 테스트가 통신 기반 테스트의 결정적인 특징이 아닌 것처럼, 불안정성도 통신 기반 테스트의 결정적인 특징이 아니다.<br/>
캡슐화를 잘 지키고 테스트를 식별할 수 있는 동작에만 결합하면 거짓 양성을 최소로 줄일 수 있다.

### 6.2.3 유지 보수성 지표로 스타일 비교하기

유지 보수성은 단위 테스트의 유지비를 측정하며, 다음 두 가지 특성으로 정의한다.

- **테스트를 이해하기 얼마나 어려운가?**
  - 테스트 크기에 대한 함수
- **테스트를 실행하기 얼마나 어려운가?**
  - 테스트에 직접적으로 관련 있는 프로세스 외부 의존성 개수에 대한 함수

#### 출력 기반 테스트의 유지 보수성

다른 두 가지 스타일과 비교하면, **출력 기반 테스트가 가장 유지 보수하기 용이하다.**<br/>
출력 기반 테스트는 거의 항상 짧고 간결하므로 유지 보수가 쉽다.<br/>

출력 기반 테스트의 기반 코드는 전역 상태나 내부 상태를 변경할 리 없으므로, 프로세스 외부 의존성을 다루지 않는다.

#### 상태 기반 테스트의 유지 보수성

상태 기반 테스트는 일반적으로 출력 기반 테스트보다 유지 보수가 쉽지 않다.<br/>
상태 검증은 종종 출력 검증보다 더 많은 공간을 차지하기 때문이다.

```csharp
[Fact]
public void Adding_a_comment_to_an_article()
{
  var sut = new Article();
  var text = "Comment Text";
  var author = "John Doe";
  var now = new DateTime(2019, 4, 1);

  sut.addCoomment(text, author, now);

  // 글의 상태를 검증
  Assert.Eqaul(1, sut.Comments.Count);
  Assert.Eqaul(text, sut.Comments[0].Text);
  Assert.Eqaul(author, sut.Comments[0].Author);
  Assert.Eqaul(now, sut.Comments[0].DateCreated);

  // 헬퍼 메서드를 사용한 검증
  sut.ShouldContainNumberOfComments(1)
    .WithComment(text, author, now);

  // 검증문 라이브러리를 써서 테스트
  sut.Comments.Should().BeEquivalentTo(comment);
}
```

상태 기반 테스트는 훨씬 많은 데이터를 확인해야 하므로 테스트 크기가 대폭 커질 수 있다.<br/>
대부분 코드를 숨기고 테스트를 단축하는 헬퍼 메서드를 사용할 순 있지만 이러한 메서드 작성과 유지에도 상당한 노력이 필요하다.<br/>

또, 검증문 라이브러리를 써서 테스트를 단순하게 할 수 있지만 클래스가 값 객체로 변환할 수 있을 때만 효과적이고,
**코드 오염(code pullution)**(단지 단위 테스트를 가능하게 하거나 단순화하기 위한 목적만으로 제품 코드베이스를 오염시키는 것)으로 이어질 가능성이 있다.<br/>

위와 같은 기법을 적용할 수 있더라도 상태 기반 테스트는 출력 기반 테스트보다 공간을 더 많이 차지하므로 유지 보수성이 떨어진다.

#### 통신 기반 테스트의 유지 보수성

통신 기반 테스트는 유지 보수성 지표에서 출력 기반 테스트와 상태 기반 테스트보다 점수가 낮다.<br/>
테스트 대역과 상호 작용 검증을 설정해야 하며, 이는 공간을 많이 차지한다.

### 6.2.4 스타일 비교하기: 결론

**출력 기반 테스트가 가장 결과가 좋다.**<br/>
구현 세부 사항과 거의 결합되지 않으므로 리팩터링 내성을 적절히 유지하고자 주의를 많이 기울일 필요가 없다.

|                                         | 출력 기반 | 상태 기반 | 통신 기반 |
| --------------------------------------- | --------- | --------- | --------- |
| 리팩터링 내성을 지키기 위해 필요한 노력 | 낮음      | 중간      | 중간      |
| 유지비                                  | 낮음      | 중간      | 높음      |

출력 기반 스타일은 함수형으로 작성된 코드에만 적용할 수 있고, 대부분의 객체지향 프로그래밍 언어에는 해당하지 않는다.<br/>
코드를 순수 함수로 만들면 상태 기반 테스트나 통신 기반 테스트 대신 출력 기반 테스트가 가능해진다.

## 6.3 함수형 아키텍처 이해

### 6.3.1 함수형 프로그래밍이란?

### 6.3.2 함수형 아키텍처란?

### 6.3.3 함수형 아키텍처와 육각형 아키텍처 비교
